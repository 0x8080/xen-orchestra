import angular from 'angular'
import angularCookies from 'angular-cookies'
import forEach from 'lodash.foreach'
import indexOf from 'lodash.indexof'
import View from 'xo-collection/view'
import xoLib from 'xo-lib'

const {
  copy: clone,
  isArray
} = angular

// ===================================================================

// Low level XO API for Angular.
export default angular.module('xo-api', [
  angularCookies
])
  .run(function ($rootScope) {
    // Ensure correct integration with Angular.
    xoLib.setScheduler(function (fn) {
      $rootScope.$evalAsync(fn)
    })
  })
  .service('xoApi', function ($cookieStore) {
    const xo = new xoLib.Xo()

    try {
      const token = $cookieStore.get('token')

      // If there is a token, sign in with it.
      if (token) {
        xo.signIn({ token })
      }
    } catch (e) {
      if (e instanceof SyntaxError) {
        $cookieStore.remove('token')
      } else {
        throw e
      }
    }

    const getObject = (function (objects) {
      const {
        all: byIds,
        indexes: {
          ref: byRefs,
          UUID: byUuids
        }
      } = objects

      return function getObject (id, type) {
        const object = byIds[id] || byUuids[id] || byRefs[id]

        if (
          // The object has been found and …
          object && (
            // … no type specified.
            !type ||

            // … is of the expected type.
            (type === object.type) ||

            // … is of one of the allowed types.
            isArray(type) && (indexOf(type, object.type) === -1)
          )
        ) {
          return object
        }
      }
    })(xo.objects)

    const viewsByType = Object.create(null)

    return {
      // -----------------
      // Session
      // -----------------

      logIn (email, password, persist) {
        return xo.signIn({ email, password }).then(() => {
          if (persist) {
            xo.call('token.create').then(function (token) {
              $cookieStore.put('token', token)
            })
          }
        })
      },
      logOut () {
        $cookieStore.remove('token')

        return xo.signOut()
      },
      get status () {
        return xo.status
      },
      get user () {
        return xo.user
      },

      // -----------------
      // RPC
      // -----------------

      call (method, params) {
        // The params need to be cloned to prevent them from being
        // changed before the method has really been sent.
        return xo.call(method, clone(params))
      },

      // -----------------
      // Objects
      // -----------------

      get (id, types) {
        if (isArray(id)) {
          const objects = []

          forEach(id, id => {
            const object = getObject(id, types)
            if (object) {
              objects.push(object)
            }
          })

          return objects
        }

        return getObject(id, types)
      },

      getView (type) {
        let view = viewsByType[type]
        if (!view) {
          const predicate = (object) => object.type === type
          view = viewsByType[type] = new View(xo.objects, predicate)
        }
        return view
      },

      all: xo.objects.all,

      byTypes: xo.objects.indexes.type
    }
  })
  .name
